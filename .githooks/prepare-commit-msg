#!/usr/bin/env bash
# Auto-prepend a tag to commit messages.
# Place this file in .githooks/ and run:
#   git config core.hooksPath .githooks
# Ensure it's executable:
#   chmod +x .githooks/prepare-commit-msg

set -euo pipefail

MSG_FILE="$1"
COMMIT_SOURCE="${2:-}"
SHA1="${3:-}"

# Skip for merge or squash commits
if [[ "$COMMIT_SOURCE" == "merge" || "$COMMIT_SOURCE" == "squash" ]]; then
  exit 0
fi

# Default tag. You can change this.
DEFAULT_TAG="CU-868fyzuq1 - "

# Optionally derive a monorepo-aware tag from staged files under packages/
# Enable by setting MONOREPO_TAG=1 in your environment or repo config.
derive_monorepo_tag() {
  local pkg
  pkg=$(git diff --cached --name-only | awk -F/ '/^packages\//{print $2; exit}') || true
  if [[ -n "${pkg:-}" ]]; then
    echo "[${pkg}] "
  else
    echo ""
  fi
}

TAG="$DEFAULT_TAG"
if [[ "${MONOREPO_TAG:-0}" == "1" ]]; then
  mono_tag=$(derive_monorepo_tag)
  if [[ -n "$mono_tag" ]]; then
    TAG="$mono_tag"
  fi
fi

# Determine first non-comment, non-empty line
first_line=$(awk 'BEGIN{found=0} /^[[:space:]]*#/ {next} /^[[:space:]]*$/ {next} {print; found=1; exit} END{if(!found) print ""}' "$MSG_FILE")

# If the message already starts with our tag, do nothing
if [[ "$first_line" == "$TAG"* ]]; then
  exit 0
fi

# Otherwise, prepend the tag to the first non-comment line
tmp=$(mktemp)
awk -v tag="$TAG" '
  BEGIN { done=0 }
  {
    if (!done && $0 !~ /^[[:space:]]*#/ && length($0) > 0) {
      print tag $0
      done=1
    } else {
      print $0
    }
  }
' "$MSG_FILE" > "$tmp"
mv "$tmp" "$MSG_FILE"
